<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NigmaJS - HMM Decryption Tool</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="guesser.css">
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.15.0/dist/tf.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="guesser-header">
            <h1>üîì HMM Decryption Tool</h1>
            <p class="subtitle">Attempt to break substitution ciphers using Hidden Markov Models</p>
        </header>

        <div class="input-card">
            <h2>üìù Ciphered Text</h2>
            <textarea id="cipherInput" placeholder="Paste ciphertext here (must be simple substitution)..."></textarea>
            
            <div id="progressContainer" style="margin-top: 1rem; display: none;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                    <span style="color: var(--text-muted);">Decrypting...</span>
                    <span id="progressText" style="color: var(--accent);">0%</span>
                </div>
                <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: var(--accent); transition: width 0.2s;"></div>
                </div>
            </div>

            <button id="btnSolve" class="tab-btn active" style="margin-top: 1rem; width: 100%; text-align: center;">
                üöÄ Attempt Decryption
            </button>
        </div>

            <div id="resultsContainer" class="input-card" style="display: none; border-color: var(--success);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h2 style="margin: 0;">üîì Decrypted Result (Live Preview)</h2>
                    <span id="methodBadge" style="background: rgba(255,255,255,0.1); padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; color: var(--accent);">
                        Method: HMM
                    </span>
                </div>
                <p id="decryptedOutput" style="font-family: monospace; white-space: pre-wrap; word-wrap: break-word; overflow-wrap: break-word; color: #e2e8f0; font-size: 1.1rem; line-height: 1.6;"></p>
            </div>

            <div class="input-card">
                <h3>How it works</h3>
                <p style="color: #94a3b8; font-size: 0.9rem; line-height: 1.6;">
                    This tool uses a hybrid approach:
                    <br><br>
                    <strong>1. Brute Force (Caesar Shift):</strong> For short texts or simple shifts, it instantly checks all 26 possibilities using Bigram analysis.
                    <br>
                    <strong>2. Hidden Markov Models (HMM):</strong> For complex substitution ciphers on longer texts (>50 chars), it uses a probabilistic model to "learn" the key.
                    <br><br>
                    <em>Note: HMM requires enough text to analyze statistics. Short texts (like "Hello World") work best with the Brute Force method.</em>
                </p>
            </div>
    </div>

    <script src="../build/js/nigma.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const btnSolve = document.getElementById('btnSolve');
            const input = document.getElementById('cipherInput');
            const output = document.getElementById('decryptedOutput');
            const container = document.getElementById('resultsContainer');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            const methodBadge = document.getElementById('methodBadge');

            btnSolve.addEventListener('click', async () => {
                const text = input.value;
                if (!text) return;

                btnSolve.innerText = "‚è≥ Solving...";
                btnSolve.disabled = true;
                output.innerText = "";
                container.style.display = 'block'; // Show container immediately
                progressContainer.style.display = 'block';
                methodBadge.innerText = "Method: Detecting...";

                // Wait for UI update
                setTimeout(async () => {
                    try {
                        const { HMMSolver } = window.nigmajs;
                        if (!HMMSolver) {
                            throw new Error("HMMSolver not loaded. Rebuild nigmajs.");
                        }

                        const solver = new HMMSolver('english');
                        await solver.initialize();
                        
                        // Use Generator for progress updates
                        for await (const status of solver.solveGenerator(text, 100)) {
                            // Update UI
                            progressBar.style.width = `${status.progress}%`;
                            progressText.innerText = `Iteration ${status.iteration}/${status.totalIterations}`;
                            output.innerText = status.decryptedText;
                            
                            // Update Method Badge
                            if (status.method) {
                                methodBadge.innerText = `Method: ${status.method === 'caesar' ? 'Brute Force (Caesar)' : 'HMM (Substitution)'}`;
                                if (status.method === 'caesar') {
                                    methodBadge.style.color = '#10b981'; // Green
                                } else {
                                    methodBadge.style.color = '#f59e0b'; // Orange
                                }
                            }
                            
                            // Scroll result into view if needed
                            if (status.iteration === 1) container.scrollIntoView({ behavior: 'smooth' });
                        }
                        
                        progressText.innerText = "Done!";
                        progressBar.style.background = "#10b981"; // Green on success

                    } catch (e) {
                        console.error(e);
                        alert("Error: " + e.message);
                    } finally {
                        btnSolve.innerText = "üöÄ Attempt Decryption";
                        btnSolve.disabled = false;
                    }
                }, 100);
            });
        });
    </script>
</body>
</html>

